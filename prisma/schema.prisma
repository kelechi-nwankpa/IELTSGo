// IELTSGo Database Schema
// Based on /docs/architecture.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum TestType {
  ACADEMIC
  GENERAL
}

enum SubscriptionTier {
  FREE
  PREMIUM
}

enum Module {
  WRITING
  SPEAKING
  READING
  LISTENING
}

enum ContentType {
  // Writing
  TASK1_ACADEMIC
  TASK1_GENERAL
  TASK2

  // Speaking
  SPEAKING_PART1
  SPEAKING_PART2
  SPEAKING_PART3

  // Reading
  READING_PASSAGE

  // Listening
  LISTENING_SECTION
}

enum UserRole {
  USER
  ADMIN
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
}

enum SubscriptionPlan {
  MONTHLY
  ANNUAL
}

// Phase 6: Study Plans & Progress enums
enum DiagnosticStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum StudyPlanStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Phase 7: Test Simulation enums
enum MockTestStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum MockTestSection {
  LISTENING
  READING
  WRITING
  SPEAKING
}

// ============================================
// MODELS
// ============================================

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  emailVerified    DateTime?        @map("email_verified")
  passwordHash     String?          @map("password_hash")
  name             String?
  image            String?
  role             UserRole         @default(USER)
  targetBand       Float?           @map("target_band")
  testDate         DateTime?        @map("test_date")
  testType         TestType?        @map("test_type")
  subscriptionTier SubscriptionTier @default(FREE) @map("subscription_tier")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Stripe subscription fields
  stripeCustomerId     String?            @unique @map("stripe_customer_id")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  subscriptionStatus   SubscriptionStatus @default(INACTIVE) @map("subscription_status")
  subscriptionPlan     SubscriptionPlan?  @map("subscription_plan")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")

  // Relations
  accounts     Account[]
  authSessions AuthSession[]
  sessions     PracticeSession[]
  evaluations  Evaluation[]
  quota        UsageQuota?
  invoices     Invoice[]

  // Phase 6: Study Plans & Progress relations
  diagnosticAssessments DiagnosticAssessment[]
  studyPlans            StudyPlan[]
  progressSnapshots     ProgressSnapshot[]
  skillAssessments      SkillAssessment[]
  achievements          UserAchievement[]
  studyStreak           StudyStreak?

  // Phase 7: Test Simulation relations
  mockTests MockTest[]

  @@map("users")
}

// NextAuth required models
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model AuthSession {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Content {
  id             String      @id @default(uuid())
  module         Module
  type           ContentType
  testType       TestType?   @map("test_type")
  difficultyBand Float?      @map("difficulty_band")
  title          String?
  contentData    Json        @map("content_data")
  answers        Json?       // For reading/listening answer keys
  isPremium      Boolean     @default(false) @map("is_premium")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  sessions PracticeSession[]

  @@map("content")
}

model PracticeSession {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  module         Module
  contentId      String    @map("content_id")
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  score          Float?    // For auto-scored modules (reading/listening)
  submissionData Json?     @map("submission_data")

  // Relations
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  content    Content      @relation(fields: [contentId], references: [id])
  evaluation Evaluation?

  @@map("practice_sessions")
}

model Evaluation {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  sessionId     String   @unique @map("session_id")
  module        Module
  promptVersion String   @map("prompt_version")
  inputText     String   @map("input_text")
  aiResponse    Json     @map("ai_response")
  bandEstimate  Float    @map("band_estimate")
  createdAt     DateTime @default(now()) @map("created_at")
  tokensUsed    Int      @map("tokens_used")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("evaluations")
}

model UsageQuota {
  id                       String   @id @default(uuid())
  userId                   String   @unique @map("user_id")
  periodStart              DateTime @map("period_start")
  writingEvaluationsUsed   Int      @default(0) @map("writing_evaluations_used")
  speakingEvaluationsUsed  Int      @default(0) @map("speaking_evaluations_used")
  explanationsUsed         Int      @default(0) @map("explanations_used")
  mockTestsUsed            Int      @default(0) @map("mock_tests_used")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_quota")
}

// Cache for AI explanations (reading/listening)
model ExplanationCache {
  id         String   @id @default(uuid())
  contentId  String   @map("content_id")
  questionId String   @map("question_id")
  explanation Json
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([contentId, questionId])
  @@map("explanation_cache")
}

// Stripe invoice history
model Invoice {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  stripeInvoiceId String   @unique @map("stripe_invoice_id")
  amountPaid      Int      @map("amount_paid") // in cents
  currency        String   @default("usd")
  status          String   // paid, open, void, etc.
  invoicePdf      String?  @map("invoice_pdf")
  createdAt       DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

// ============================================
// PHASE 6: STUDY PLANS & PROGRESS MODELS
// ============================================

// Diagnostic assessment results - captures initial and periodic assessments
model DiagnosticAssessment {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  status        DiagnosticStatus @default(NOT_STARTED)

  // Estimated bands per module (null if not yet assessed)
  listeningBand Float? @map("listening_band")
  readingBand   Float? @map("reading_band")
  writingBand   Float? @map("writing_band")
  speakingBand  Float? @map("speaking_band")
  overallBand   Float? @map("overall_band")

  // Weak areas identified (JSONB array of skill identifiers)
  weakAreas Json? @map("weak_areas")

  // Session references for diagnostic practice
  diagnosticData Json? @map("diagnostic_data") // Stores question responses

  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyPlans StudyPlan[]

  @@map("diagnostic_assessments")
}

// User's study plan configuration and generated plan
model StudyPlan {
  id           String @id @default(uuid())
  userId       String @map("user_id")
  diagnosticId String? @map("diagnostic_id")

  // User inputs
  targetBand       Float @map("target_band")
  testDate         DateTime? @map("test_date")
  hoursPerDay      Float @map("hours_per_day") // e.g., 1.5, 2, 3
  studyDaysPerWeek Int   @default(5) @map("study_days_per_week")

  // Plan status and metadata
  status      StudyPlanStatus @default(DRAFT)
  currentWeek Int             @default(1) @map("current_week")

  // AI-generated plan content (JSONB)
  planData      Json   @map("plan_data") // Full StudyPlan structure from AI
  promptVersion String @map("prompt_version")
  tokensUsed    Int    @map("tokens_used")

  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastRegeneratedAt DateTime? @map("last_regenerated_at")

  // Relations
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  diagnostic DiagnosticAssessment? @relation(fields: [diagnosticId], references: [id])
  tasks      StudyTask[]
  goals      WeeklyGoal[]

  @@map("study_plans")
}

// Weekly goal tracking
model WeeklyGoal {
  id          String @id @default(uuid())
  studyPlanId String @map("study_plan_id")
  weekNumber  Int    @map("week_number")

  // Goals per module (JSONB with structure {module: string, target: number, description: string})
  goals     Json
  theme     String // e.g., "Foundation Building", "Intensive Practice"
  milestone String // What user should achieve by week end

  // Progress tracking
  completedTasks Int @default(0) @map("completed_tasks")
  totalTasks     Int @map("total_tasks")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  studyPlan StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)

  @@unique([studyPlanId, weekNumber])
  @@map("weekly_goals")
}

// Individual study tasks (daily recommendations)
model StudyTask {
  id          String @id @default(uuid())
  studyPlanId String @map("study_plan_id")

  // Task details
  module      Module
  title       String
  description String
  duration    Int          // in minutes
  priority    TaskPriority @default(MEDIUM)

  // Scheduling
  scheduledDate DateTime @map("scheduled_date")
  weekNumber    Int      @map("week_number")
  dayOfWeek     Int      @map("day_of_week") // 0-6

  // Status tracking
  status      TaskStatus @default(PENDING)
  completedAt DateTime?  @map("completed_at")

  // Link to practice session if applicable
  sessionId String? @map("session_id")

  // Task metadata (JSONB for flexible activity types)
  metadata Json? // e.g., {activityType: "passage", contentId: "...", difficulty: 6.5}

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  studyPlan StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)

  @@index([studyPlanId, scheduledDate])
  @@index([studyPlanId, status])
  @@map("study_tasks")
}

// Progress snapshots for trend analysis
model ProgressSnapshot {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Scores at this point in time
  listeningBand Float? @map("listening_band")
  readingBand   Float? @map("reading_band")
  writingBand   Float? @map("writing_band")
  speakingBand  Float? @map("speaking_band")
  overallBand   Float? @map("overall_band")

  // Skill-level metrics (JSONB)
  skillBreakdown Json? @map("skill_breakdown")

  // Completion metrics
  sessionsCompleted Int @default(0) @map("sessions_completed")
  tasksCompleted    Int @default(0) @map("tasks_completed")
  studyMinutes      Int @default(0) @map("study_minutes")

  // Context
  weekNumber  Int?    @map("week_number")
  studyPlanId String? @map("study_plan_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("progress_snapshots")
}

// User skill tracking for weak area identification
model SkillAssessment {
  id     String @id @default(uuid())
  userId String @map("user_id")
  module Module

  // Skill identifier (e.g., "reading_tfng", "writing_task2_coherence", "speaking_fluency")
  skillId   String @map("skill_id")
  skillName String @map("skill_name")

  // Performance tracking
  currentLevel  Float     @map("current_level") // 0-9 scale
  attempts      Int       @default(0)
  lastPracticed DateTime? @map("last_practiced")

  // Trend data
  improvementRate Float? @map("improvement_rate") // band change per week

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId, module])
  @@map("skill_assessments")
}

// User achievements for gamification
model UserAchievement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id") // e.g., "first_steps", "7_day_streak"
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  metadata      Json?    // Extra data like band achieved, streak count

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// Study streak tracking for gamification
model StudyStreak {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  currentStreak  Int       @default(0) @map("current_streak")
  longestStreak  Int       @default(0) @map("longest_streak")
  lastStudyDate  DateTime? @map("last_study_date")
  totalStudyDays Int       @default(0) @map("total_study_days")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_streaks")
}

// ============================================
// PHASE 7: TEST SIMULATION MODELS
// ============================================

// Full mock test session tracking
model MockTest {
  id       String         @id @default(uuid())
  userId   String         @map("user_id")
  testType TestType       // ACADEMIC or GENERAL
  status   MockTestStatus @default(NOT_STARTED)

  // Section timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Section deadline tracking (for enforcing time limits)
  currentSectionStartedAt  DateTime?        @map("current_section_started_at")
  currentSectionDeadline   DateTime?        @map("current_section_deadline")
  currentSection           MockTestSection? @map("current_section")

  // Section session references (linked to PracticeSession)
  listeningSessionId String? @unique @map("listening_session_id")
  readingSessionId   String? @unique @map("reading_session_id")
  writingSessionId   String? @unique @map("writing_session_id")
  // Speaking has multiple parts, stored as JSON array of session IDs
  speakingSessionIds String[] @map("speaking_session_ids")

  // Results (populated on completion)
  listeningBand Float? @map("listening_band")
  readingBand   Float? @map("reading_band")
  writingBand   Float? @map("writing_band")
  speakingBand  Float? @map("speaking_band")
  overallBand   Float? @map("overall_band")

  // Time tracking metadata (JSON with actual time spent per section)
  sectionTimes Json? @map("section_times")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt])
  @@map("mock_tests")
}
