// IELTSGo Database Schema
// Based on /docs/architecture.md

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum TestType {
  ACADEMIC
  GENERAL
}

enum SubscriptionTier {
  FREE
  PREMIUM
}

enum Module {
  WRITING
  SPEAKING
  READING
  LISTENING
}

enum ContentType {
  // Writing
  TASK1_ACADEMIC
  TASK1_GENERAL
  TASK2

  // Speaking
  SPEAKING_PART1
  SPEAKING_PART2
  SPEAKING_PART3

  // Reading
  READING_PASSAGE

  // Listening
  LISTENING_SECTION
}

// ============================================
// MODELS
// ============================================

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  passwordHash     String?          @map("password_hash")
  name             String?
  targetBand       Float?           @map("target_band")
  testDate         DateTime?        @map("test_date")
  testType         TestType?        @map("test_type")
  subscriptionTier SubscriptionTier @default(FREE) @map("subscription_tier")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  sessions    PracticeSession[]
  evaluations Evaluation[]
  quota       UsageQuota?

  @@map("users")
}

model Content {
  id             String      @id @default(uuid())
  module         Module
  type           ContentType
  testType       TestType?   @map("test_type")
  difficultyBand Float?      @map("difficulty_band")
  title          String?
  contentData    Json        @map("content_data")
  answers        Json?       // For reading/listening answer keys
  isPremium      Boolean     @default(false) @map("is_premium")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  sessions PracticeSession[]

  @@map("content")
}

model PracticeSession {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  module         Module
  contentId      String    @map("content_id")
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  score          Float?    // For auto-scored modules (reading/listening)
  submissionData Json?     @map("submission_data")

  // Relations
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  content    Content      @relation(fields: [contentId], references: [id])
  evaluation Evaluation?

  @@map("practice_sessions")
}

model Evaluation {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  sessionId     String   @unique @map("session_id")
  module        Module
  promptVersion String   @map("prompt_version")
  inputText     String   @map("input_text")
  aiResponse    Json     @map("ai_response")
  bandEstimate  Float    @map("band_estimate")
  createdAt     DateTime @default(now()) @map("created_at")
  tokensUsed    Int      @map("tokens_used")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("evaluations")
}

model UsageQuota {
  id                       String   @id @default(uuid())
  userId                   String   @unique @map("user_id")
  periodStart              DateTime @map("period_start")
  writingEvaluationsUsed   Int      @default(0) @map("writing_evaluations_used")
  speakingEvaluationsUsed  Int      @default(0) @map("speaking_evaluations_used")
  explanationsUsed         Int      @default(0) @map("explanations_used")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_quota")
}

// Cache for AI explanations (reading/listening)
model ExplanationCache {
  id         String   @id @default(uuid())
  contentId  String   @map("content_id")
  questionId String   @map("question_id")
  explanation Json
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([contentId, questionId])
  @@map("explanation_cache")
}
